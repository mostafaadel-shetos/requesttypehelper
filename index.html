<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Request Type Helper</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          animation: {
            'fade-in': 'fadeIn 0.2s ease-out',
            'slide-up': 'slideUp 0.3s ease-out'
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
          }
        }
      }
    }
  </script>

  <style>
    body { font-family: 'Inter', sans-serif; }
    .request-path { font-size: 0.75rem; margin-bottom: 0.5rem; font-weight: 500; }
    @keyframes pulse-border {
      0% { border-color: rgba(79, 70, 229, 0.4); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0.2); }
      70% { border-color: rgba(79, 70, 229, 1); box-shadow: 0 0 0 6px rgba(79, 70, 229, 0); }
      100% { border-color: rgba(79, 70, 229, 0.4); box-shadow: 0 0 0 0 rgba(79, 70, 229, 0); }
    }
    .best-match { border-width: 2px; animation: pulse-border 2s infinite; }
    .results-scroll::-webkit-scrollbar { width: 8px; }
    .results-scroll::-webkit-scrollbar-track { background: transparent; }
    .results-scroll::-webkit-scrollbar-thumb { background-color: rgba(156,163,175,0.5); border-radius: 20px; }
    #copy-toast { pointer-events: none; }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-200">
  <div id="app" class="min-h-screen p-4 sm:p-8"></div>

  <script>
  // -----------------------
  // Configuration
  // -----------------------
  const MAIN_DATA_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvs2dBHF01vfJADCqiPjvM1ZFrZ9DRQpBbMC57BHK-kFe2KK7TmZiIaQXUoaEelVuqh-AZzS5HKEoG/pub?output=csv';
  const GUIDE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/1MMe9-KxDDoNVK2PZTrtP2hjyQfm4xrfog3tdJZzaRf4/export?format=csv&gid=372968059';
  const AUTO_REFRESH_INTERVAL = 300000;
  const LOGO_URL = 'https://i.ibb.co/MkQ18QyV/Logo.png';

  const STOP_WORDS = new Set(['a','an','the','and','or','but','is','are','was','were','be','been','in','on','at','to','for','from','of','with','by','about','i','my','me','we','our','us','you','your','he','his','him','she','her','it','its','they','their','them','this','that','these','those','have','has','had','do','does','did','can','could','will','would','should','want','wants','need','needs','please','help','hi','hello','regarding','issue','problem','question','ask','asking','customer','client','user','very','upset','angry','because']);
  const ALL_KNOWN_PRODUCTS = ['Studio','Move','Core','MegaSafe','BYOD','App','Accessories','Miscellaneous'];

  const CONCEPT_MAP = {
    studio: {term:'Studio',type:'product'},
    move: {term:'Move',type:'product'},
    core: {term:'Core',type:'product'},
    megasafe: {term:'MegaSafe',type:'product'},
    byod: {term:'BYOD',type:'product'},
    mobile: {term:'App',type:'product'},
    app: {term:'App',type:'product'},
    iphone: {term:'App',type:'product'},
    android: {term:'App',type:'product'},
    accessory: {term:'Accessories',type:'product'},
    accessories: {term:'Accessories',type:'product'},
    order: {term:'Order',type:'category'},
    shipping: {term:'Shipping',type:'category'},
    delivery: {term:'Delivery',type:'category'},
    billing: {term:'Billing',type:'category'},
    account: {term:'Account',type:'category'},
    content: {term:'Content',type:'category'},
    membership: {term:'Membership',type:'category'},
    prospective: {term:'Prospective',type:'category'},
    sales: {term:'Prospective',type:'category'}
  };

  const GUIDE_L1_PLUS_OPTIONS = [
    { label: "Order Support", keywords: ["order"] },
    { label: "Product Support", keywords: ["product support", "technical"] },
    { label: "Prospective", keywords: ["prospective", "sales"] },
    { label: "Account / Billing", keywords: ["account", "billing", "membership"] },
    { label: "Content", keywords: ["content", "class"] },
    { label: "Shipping / Delivery", keywords: ["shipping", "delivery"] }
  ];

  // -----------------------
  // State
  // -----------------------
  let requestTypesData = [];
  let guideData = [];
  let wordFrequency = {};
  let totalDocuments = 0;
  let selectedL1 = '', selectedL2 = '', selectedL3 = '';
  let currentFinalRequest = null;
  let searchTerm = '';
  let isLoading = true;
  let isLayoutLoaded = false;
  let errorMsg = null;
  let guideStack = [];
  let isDarkMode = false;

  try { isDarkMode = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches); } catch(e){}

  const appDiv = document.getElementById('app');
  if (isDarkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');

  // -----------------------
  // Helpers
  // -----------------------
  function simpleStem(w){
    if(!w) return '';
    if(w.length<4) return w;
    if(w.endsWith('ing')) return w.slice(0,-3);
    if(w.endsWith('ed')) return w.slice(0,-2);
    if(w.endsWith('es')) return w.slice(0,-2);
    if(w.endsWith('s') && !w.endsWith('ss')) return w.slice(0,-1);
    return w;
  }
  function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
  function matchesToken(text, token){
    if(!text) return false;
    const pat = new RegExp('\\b' + escapeRegExp(token), 'i');
    return pat.test(text);
  }

  function getIcon(name, customClass=''){
    // Minimal icons to avoid very long inline SVGs and keep file readable
    if(name==='Search') return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="${customClass}"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>`;
    if(name==='Check') return `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" class="${customClass}"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    if(name==='Loader') return `<svg width="24" height="24" viewBox="0 0 50 50" class="${customClass}"><circle cx="25" cy="25" r="20" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.4 31.4"/></svg>`;
    if(name==='ChevronLeft') return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    if(name==='X') return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    if(name==='Compass') return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><path d="M16 8l-8 4 4 4 4-8z" fill="currentColor"/></svg>`;
    return '';
  }

  // -----------------------
  // CSV parsing + indexing
  // -----------------------
  function parseCSV(str){
    const rows = [];
    let row = [], cur = '', inQuotes = false;
    for(let i=0;i<str.length;i++){
      const ch = str[i], nxt = str[i+1];
      if(ch === '"' && inQuotes && nxt === '"'){ cur += '"'; i++; continue; }
      if(ch === '"'){ inQuotes = !inQuotes; continue; }
      if(ch === ',' && !inQuotes){ row.push(cur); cur = ''; continue; }
      if((ch === '\n' || ch === '\r') && !inQuotes){
        if(ch === '\r' && nxt === '\n'){ i++; }
        row.push(cur); rows.push(row); row = []; cur = ''; continue;
      }
      cur += ch;
    }
    if(cur !== '' || row.length) { row.push(cur); rows.push(row); }
    return rows;
  }

  function buildSearchIndex(data){
    wordFrequency = {};
    totalDocuments = data.length;
    data.forEach(item=>{
      const text = `${item.L1} ${item.L2} ${item.L3} ${item.description}`.toLowerCase();
      const tokens = text.replace(/[.,/#!$%^&*;:{}=\-_`~()]/g," ").split(/\s+/);
      tokens.forEach(t=>{
        if(t.length>2 && !STOP_WORDS.has(t)){
          const stem = simpleStem(t);
          wordFrequency[stem] = (wordFrequency[stem] || 0) + 1;
        }
      });
    });
  }

  async function fetchWithRetry(url, retries=3){
    for(let i=0;i<retries;i++){
      try {
        const r = await fetch(url);
        if(!r.ok) throw new Error('HTTP ' + r.status);
        return await r.text();
      } catch(e){
        if(i===retries-1) throw e;
        await new Promise(r=>setTimeout(r,1000));
      }
    }
  }

  // -----------------------
  // Fetch data + render
  // -----------------------
  async function fetchData(isBackground=false){
    if(!isBackground){
      isLoading = true; isLayoutLoaded = false; errorMsg = null;
      selectedL1 = selectedL2 = selectedL3 = ''; currentFinalRequest = null; searchTerm = '';
      renderApp();
    } else {
      const refreshIcon = document.querySelector('#refresh-btn svg');
      if(refreshIcon) refreshIcon.classList.add('animate-spin');
    }

    try {
      const ts = Date.now();
      const mainText = await fetchWithRetry(MAIN_DATA_CSV_URL + '&t=' + ts);
      if(mainText.trim().startsWith('<!DOCTYPE') || mainText.trim().startsWith('<html')) throw new Error('Invalid CSV');
      const rows = parseCSV(mainText);
      const newData = rows.slice(1).map(r=>({
        L1: (r[0]||'').trim(),
        L2: (r[1]||'').trim(),
        L3: (r[2]||'').trim(),
        description: (r[3]||'').trim()
      })).filter(x=>x && x.L1);
      // guide data
      if(GUIDE_SHEET_CSV_URL && !GUIDE_SHEET_CSV_URL.includes('PASTE_YOUR_GUIDE')){
        try {
          const guideText = await fetchWithRetry(GUIDE_SHEET_CSV_URL + '&t=' + ts);
          const guideRows = parseCSV(guideText);
          guideData = guideRows.slice(1).map(r=>({
            L1: (r[0]||'').trim(),
            L1Plus: (r[1]||'').trim(),
            L2: (r[2]||'').trim(),
            L3: (r[3]||'').trim()
          })).filter(x=>x && x.L1);
        } catch(e){ console.warn('Guide load failed', e); }
      }

      if(newData.length === 0) throw new Error('No data found.');
      requestTypesData = newData;
      buildSearchIndex(requestTypesData);
      isLoading = false;
      renderApp();
      updateFooter();
    } catch(err){
      if(!isBackground){
        isLoading = false;
        errorMsg = err.message || String(err);
        renderApp();
      } else {
        console.warn('Background sync failed', err);
      }
    } finally {
      if(isBackground){
        const refreshIcon = document.querySelector('#refresh-btn svg');
        if(refreshIcon) refreshIcon.classList.remove('animate-spin');
      }
    }
  }

  // -----------------------
  // UI helpers
  // -----------------------
  function debounce(fn, delay){
    let t;
    return function(...a){ clearTimeout(t); t = setTimeout(()=>fn.apply(this,a), delay); };
  }

  function getUniqueOptions(key, filterL1='', filterL2=''){
    let data = requestTypesData;
    if(filterL1) data = data.filter(d=>d.L1 === filterL1);
    if(filterL2) data = data.filter(d=>d.L2 === filterL2);
    const seen = new Set(); const out = [];
    for(const r of data){
      const v = r[key];
      if(v && !seen.has(v)){ seen.add(v); out.push(v); }
    }
    return out;
  }

  function handleThemeToggle(){
    isDarkMode = !isDarkMode;
    if(isDarkMode) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
    try { localStorage.setItem('theme', isDarkMode ? 'dark' : 'light'); } catch(e){}
    const btn = document.getElementById('theme-btn'); if(btn) btn.innerHTML = isDarkMode ? getIcon('Sun') : getIcon('Moon');
  }

  // -----------------------
  // Guide modal + copy function
  // -----------------------
  function handleEscPress(e){ if(e.key === 'Escape') closeGuide(); }

  function openGuide(){
    if(guideData.length === 0){ alert('Guide data not loaded. Please check the CSV URL.'); return; }
    guideStack = [];
    renderGuideStep();
    document.getElementById('guide-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.addEventListener('keydown', handleEscPress);
  }
  function closeGuide(){
    document.getElementById('guide-modal').classList.add('hidden');
    document.body.style.overflow = '';
    document.removeEventListener('keydown', handleEscPress);
  }
  function guideBack(){
    if(guideStack.length>0){ guideStack.pop(); renderGuideStep(); }
  }
  function handleGuideSelection(value){ guideStack.push(value); renderGuideStep(); }

  // New: copy selected request type + description
  function copyGuideSelection(gL1, gL1Plus, gL2, gL3, autoClose = true){
    const combined = [gL1, gL2, gL3].filter(Boolean).join(' > ');
    const match = requestTypesData.find(r => r.L1 === gL1 && r.L2 === gL2 && r.L3 === gL3);
    const desc = match ? match.description : '';
    const text = combined + (desc ? '\n\n' + desc : '');
    if(!text || text.trim() === ''){ alert('Nothing to copy for this selection.'); return; }

    const write = (txt) => {
      if(navigator.clipboard && navigator.clipboard.writeText){
        return navigator.clipboard.writeText(txt);
      } else {
        // fallback
        const ta = document.createElement('textarea');
        ta.value = txt; ta.style.position = 'fixed'; ta.style.left = '-9999px';
        document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); ta.remove(); return Promise.resolve(); } catch(e){ ta.remove(); return Promise.reject(e); }
      }
    };

    write(text).then(()=>{
      showCopyToast('Copied request type to clipboard');
      if(autoClose) closeGuide();
    }).catch(err=>{
      // fallback prompt
      try {
        window.prompt('Copy the text below (Ctrl/Cmd+C):', text);
      } catch(e){}
    });
  }

  function showCopyToast(msg){
    const id = 'copy-toast';
    let el = document.getElementById(id);
    if(!el){ el = document.createElement('div'); el.id = id; el.className = 'fixed bottom-6 right-6 bg-black/80 text-white text-sm py-2 px-4 rounded-lg shadow-lg z-[9999]'; el.style.opacity = '0'; el.style.transition = 'opacity 200ms ease'; document.body.appendChild(el); }
    el.textContent = msg;
    requestAnimationFrame(()=> el.style.opacity = '1');
    clearTimeout(el._hideTO);
    el._hideTO = setTimeout(()=> el.style.opacity = '0', 1600);
  }

  // keep original useGuideSelection around in case other code expects it (no-op compared to copy)
  function useGuideSelection(gL1, gL1Plus, gL2, gL3){
    // original behaviour: reset tree and close guide
    selectedL1 = ''; selectedL2 = ''; selectedL3 = ''; currentFinalRequest = null;
    closeGuide();
    renderTreePanelOnly();
  }

  function determineRequestNature(description){
    if(!description) return 'Issue or Inquiry';
    const d = description.toLowerCase();
    const inquiry = ['how to','question','inquiry','info','status','track','where is','clarify','update'];
    const issue = ['broken','damaged','error','fail','not working','issue','problem','defect','refund','return','cancel'];
    if(issue.some(k=>d.includes(k))) return 'Issue';
    if(inquiry.some(k=>d.includes(k))) return 'Inquiry';
    return 'Issue or Inquiry';
  }

  // -----------------------
  // Guide rendering
  // -----------------------
  function renderGuideStep(){
    const container = document.getElementById('guide-content');
    const title = document.getElementById('guide-title');
    const backBtn = document.getElementById('guide-back-btn');
    if(!container) return;

    const currentLevel = guideStack.length + 1;
    const selL1 = guideStack[0];
    const selL1Plus = guideStack[1];
    const selL2 = guideStack[2];

    if(currentLevel > 1) backBtn.classList.remove('invisible'); else backBtn.classList.add('invisible');

    let options = [];
    let isFinal = false;
    let finalItem = null;

    if(currentLevel === 1){
      title.innerText = 'Select Product';
      options = Array.from(new Set(guideData.map(r=>r.L1))).filter(Boolean);
    } else if(currentLevel === 2){
      title.innerText = `Select Type for ${selL1}`;
      options = Array.from(new Set(guideData.filter(r=>r.L1===selL1).map(r=>r.L1Plus)));
      if(options.length === 1 && !options[0]){ guideStack.push(''); renderGuideStep(); return; }
    } else if(currentLevel === 3){
      title.innerText = 'Select Category';
      options = Array.from(new Set(guideData.filter(r=>r.L1===selL1 && r.L1Plus===selL1Plus).map(r=>r.L2)));
      if(options.length === 0 || (options.length === 1 && !options[0])) isFinal = true;
    } else if(currentLevel === 4){
      title.innerText = 'Select Issue or Inquiry';
      options = Array.from(new Set(guideData.filter(r=>r.L1===selL1 && r.L1Plus===selL1Plus && r.L2===selL2).map(r=>r.L3)));
      if(options.length === 0 || (options.length === 1 && !options[0])) isFinal = true;
    } else {
      isFinal = true;
    }

    if(isFinal){
      const selL3 = guideStack[3] || '';
      const categoryObj = GUIDE_L1_PLUS_OPTIONS.find(c => c.label === selL1Plus);
      const categoryKeywords = categoryObj ? categoryObj.keywords : [ (selL1Plus||'').toLowerCase() ];

      const validRows = requestTypesData.filter(row=>{
        const l1 = (row.L1||'').toLowerCase();
        const prod = (selL1||'').toLowerCase();
        const matchesKeyword = categoryKeywords.some(k => l1.includes(k));
        if(!matchesKeyword) return false;
        const isSpecific = l1.includes(prod);
        const isGeneric = !ALL_KNOWN_PRODUCTS.some(p => l1.includes((p||'').toLowerCase()));
        return (isSpecific || isGeneric) && row.L2 === selL2 && row.L3 === selL3;
      });

      finalItem = validRows[0] || null;
      title.innerText = 'Confirm Selection';
      const descText = finalItem ? (finalItem.description || 'No description provided.') : 'Description not available for this specific combination.';
      const combinedReqType = finalItem ? `${finalItem.L1} > ${finalItem.L2} > ${finalItem.L3}` : `${selL1} (Combined) > ${selL2} > ${selL3}`;
      const issueOrInquiryLabel = determineRequestNature(descText);

      container.innerHTML = `
        <div class="animate-fade-in p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
          <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
            <div><div class="text-xs text-gray-500 uppercase font-bold mb-1">Product</div><div class="text-gray-900 dark:text-white font-medium">${escapeHtml(selL1||'-')}</div></div>
            <div><div class="text-xs text-gray-500 uppercase font-bold mb-1">Type</div><div class="text-gray-900 dark:text-white font-medium">${escapeHtml(selL1Plus||'-')}</div></div>
            <div><div class="text-xs text-gray-500 uppercase font-bold mb-1">Category</div><div class="text-gray-900 dark:text-white font-medium">${escapeHtml(selL2||'-')}</div></div>
            <div><div class="text-xs text-gray-500 uppercase font-bold mb-1">${escapeHtml(issueOrInquiryLabel)}</div><div class="text-gray-900 dark:text-white font-medium">${escapeHtml(selL3||'-')}</div></div>
          </div>

          <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800">
            <div class="text-xs text-blue-600 dark:text-blue-400 uppercase font-bold mb-1">Full Request Type</div>
            <div class="text-gray-900 dark:text-white font-semibold text-sm break-words">${escapeHtml(combinedReqType)}</div>
          </div>

          <div class="mb-6">
            <div class="text-xs text-gray-500 uppercase font-bold mb-2">Description</div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 leading-relaxed text-sm max-h-40 overflow-auto">
              ${escapeHtml(descText)}
            </div>
          </div>

          <div class="space-y-2">
            <button id="copy-guide-btn" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg">Copy Request Type</button>
            <button id="use-guide-btn" class="w-full py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg">Use (reset tree) — original behavior</button>
          </div>
        </div>
      `;

      // wire buttons
      document.getElementById('copy-guide-btn').addEventListener('click', ()=>{
        copyGuideSelection(selL1||'', selL1Plus||'', selL2||'', selL3||'', true);
      });
      document.getElementById('use-guide-btn').addEventListener('click', ()=>{
        useGuideSelection(selL1||'', selL1Plus||'', selL2||'', selL3||'');
      });

    } else {
      const buttonsHtml = options.map(opt=>{
        const label = opt || 'General';
        return `<button class="group p-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 hover:border-indigo-300 dark:hover:border-indigo-600 text-left" data-val="${escapeHtml(opt||'')}">
          <div class="font-semibold text-gray-800 dark:text-gray-200 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 flex justify-between items-center">
            ${escapeHtml(label)}
            <span class="opacity-0 group-hover:opacity-100 transition-opacity text-indigo-500">→</span>
          </div>
        </button>`;
      }).join('');
      container.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto pr-2">${buttonsHtml}</div>`;

      // attach click handlers
      Array.from(container.querySelectorAll('button[data-val]')).forEach(btn=>{
        btn.addEventListener('click', ()=> handleGuideSelection(btn.getAttribute('data-val')));
      });
    }
  }

  // simple HTML escape for injected values
  function escapeHtml(str){
    if(str === null || str === undefined) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }

  // -----------------------
  // Search scoring + results
  // -----------------------
  function calculateScore(item, tokens, targetProducts, targetCategories){
    let weighted = 0;
    const l3 = (item.L3||'').toLowerCase();
    const l2 = (item.L2||'').toLowerCase();
    const l1 = (item.L1||'').toLowerCase();
    const desc = (item.description||'').toLowerCase();

    let rowContextProduct = null;
    for(const p of ALL_KNOWN_PRODUCTS){ if(l1.includes(p.toLowerCase()) || l2.includes(p.toLowerCase())) { rowContextProduct = p; break; } }

    if(targetProducts.length > 0){
      if(rowContextProduct){
        const rowProdNorm = rowContextProduct.toLowerCase();
        const isTargetMatch = targetProducts.some(tp => tp.toLowerCase() === rowProdNorm);
        if(isTargetMatch) weighted += 40; else return { ...item, displayPercent:0, sortScore:0 };
      } else weighted += 10;
    }

    let matchesFound = 0;
    tokens.forEach(token=>{
      const stem = simpleStem(token);
      const freq = wordFrequency[stem] || 1;
      const weight = Math.log(Math.max(1, totalDocuments) / (freq + 1)) + 1;
      let tokenMatched = false;
      if(matchesToken(l1, token) || matchesToken(l1, stem)){ weighted += weight * 20; tokenMatched = true; }
      if(matchesToken(l2, token) || matchesToken(l2, stem)){ weighted += weight * 15; tokenMatched = true; }
      if(matchesToken(l3, token) || matchesToken(l3, stem)){ weighted += weight * 15; tokenMatched = true; }
      if(matchesToken(desc, token) || matchesToken(desc, stem)){ weighted += weight * 5; tokenMatched = true; }
      if(tokenMatched) matchesFound++;
    });

    if(tokens.length > 0){
      const ratio = matchesFound / tokens.length;
      weighted = weighted * (ratio * ratio);
    }

    const maxRef = 100;
    const normalizedScore = Math.min(100, Math.round((weighted / maxRef) * 100));
    return { ...item, displayPercent: normalizedScore, sortScore: weighted };
  }

  function renderCard(req, score = null, isBest=false){
    const full = [req.L1, req.L2, req.L3].filter(Boolean).join(' > ');
    const badge = score !== null ? `<span class="px-2 py-1 text-xs rounded bg-gray-100">${score}%</span>` : '';
    return `
      <div class="p-5 rounded-xl border bg-white dark:bg-gray-800 dark:border-gray-700 shadow-sm">
        <div class="flex justify-between items-start mb-3">
          <div class="text-sm font-bold">${escapeHtml(full)}</div>
          ${badge}
        </div>
        <div class="text-sm text-gray-700 dark:text-gray-200">${escapeHtml(req.description || 'No description provided.')}</div>
      </div>`;
  }

  // -----------------------
  // Rendering: Shell / Search / Tree
  // -----------------------
  function renderShell(){
    appDiv.innerHTML = `
      <div id="main-interface" class="max-w-5xl mx-auto space-y-8 pb-12 animate-fade-in relative">
        <div id="guide-modal" class="fixed inset-0 z-[100] hidden">
          <div class="absolute inset-0 bg-black/60" onclick="window.closeGuide && window.closeGuide()"></div>
          <div class="absolute inset-x-0 bottom-0 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 bg-white dark:bg-gray-900 sm:rounded-2xl shadow-2xl p-6 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-6">
              <button id="guide-back-btn" class="p-2 -ml-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-600 invisible">${getIcon('ChevronLeft')}</button>
              <h3 id="guide-title" class="text-lg font-bold text-gray-900 dark:text-white text-center flex-1">Select Level 1</h3>
              <button id="guide-close" class="p-2 -mr-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500">${getIcon('X')}</button>
            </div>
            <div id="guide-content" class="flex-1 overflow-y-auto min-h-[300px]">
            </div>
          </div>
        </div>

        <header class="border-b dark:border-gray-700 pb-4">
          <div class="flex justify-center mb-4 h-16 items-center">
            <img src="${LOGO_URL}" alt="Logo" class="h-16 w-auto object-contain" onerror="this.style.display='none'"/>
          </div>
          <div class="flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-gray-900 dark:text-white tracking-tight">Request Type Helper</h1>
            <div class="flex gap-2">
              <button id="guide-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold py-2 px-4 rounded-lg inline-flex items-center">${getIcon('Compass','text-white')}<span class="ml-2 hidden sm:inline">Guide</span></button>
              <button id="theme-btn" class="p-2 rounded-lg bg-gray-100 dark:bg-gray-700">${getIcon('Sun')}</button>
              <button id="refresh-btn" class="bg-white dark:bg-gray-800 py-2 px-3 rounded-lg">${getIcon('Refresh') || ''}</button>
            </div>
          </div>
        </header>

        <main class="flex flex-col gap-8">
          <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <h2 class="font-bold text-gray-700 dark:text-gray-200 mb-3 text-lg">Keyword Search</h2>
            <div class="relative">
              <input id="search-input" oninput="window.handleSearchInput && window.handleSearchInput(event)" type="text" placeholder="Search with the customer's inquiry or describe the issue..." class="w-full p-4 pl-10 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100"/>
              <div class="absolute left-3 top-3">${getIcon('Search')}</div>
            </div>
            <div id="search-results-area" class="mt-4"></div>
          </div>

          <section id="tree-panel-area" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"></section>
        </main>

        <footer class="text-center text-xs text-gray-400 dark:text-gray-500">Connected to Live Sheet • ${requestTypesData.length} Request Types Loaded</footer>
      </div>
    `;

    // attach guide modal controls
    document.getElementById('guide-btn').addEventListener('click', openGuide);
    document.getElementById('guide-close').addEventListener('click', closeGuide);
    document.getElementById('guide-back-btn').addEventListener('click', guideBack);
    document.getElementById('theme-btn').addEventListener('click', handleThemeToggle);
    document.getElementById('refresh-btn').addEventListener('click', ()=> fetchData(false));
    isLayoutLoaded = true;
  }

  function renderSearchResultsOnly(currentSearchTerm = searchTerm){
    const container = document.getElementById('search-results-area');
    if(!container) return;
    const normalized = (currentSearchTerm || '').toLowerCase().replace(/[.,/#!$%^&*;:{}=\-_`~()]/g," ");
    const tokens = normalized.split(/\s+/).filter(t=>t.length>2 && !STOP_WORDS.has(t));
    const targetProducts = [], targetCategories = [];
    tokens.forEach(t=>{
      const s = simpleStem(t);
      if(CONCEPT_MAP[t]) { if(CONCEPT_MAP[t].type==='product') targetProducts.push(CONCEPT_MAP[t].term); if(CONCEPT_MAP[t].type==='category') targetCategories.push(CONCEPT_MAP[t].term); }
      else if(CONCEPT_MAP[s]) { if(CONCEPT_MAP[s].type==='product') targetProducts.push(CONCEPT_MAP[s].term); if(CONCEPT_MAP[s].type==='category') targetCategories.push(CONCEPT_MAP[s].term); }
    });

    let searchResults = [];
    if(tokens.length > 0){
      searchResults = requestTypesData.map(item => calculateScore(item, tokens, targetProducts, targetCategories))
        .filter(i => i.displayPercent > 5)
        .sort((a,b) => b.sortScore - a.sortScore);
    }

    if(searchResults.length > 0){
      const topScore = searchResults[0].sortScore || 0;
      searchResults = searchResults.map((it, idx) => ({...it, isBestFit: idx < 3 && it.sortScore >= (topScore * 0.9)})).slice(0,12);
      container.innerHTML = `<div class="mt-4 space-y-4"><p class="text-sm text-gray-500 dark:text-gray-400">Found ${searchResults.length} relevant results.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${searchResults.map(r=>renderCard(r, r.displayPercent, r.isBestFit)).join('')}</div></div>`;
    } else if(tokens.length > 0){
      container.innerHTML = `<div class="text-center py-8 bg-gray-50 dark:bg-gray-800/50 rounded-xl mt-4 border border-gray-100 dark:border-gray-700">${getIcon('Search')}<p class="mt-2 text-lg font-semibold">No results found</p></div>`;
    } else {
      container.innerHTML = `<div class="text-center py-8 bg-gray-50 dark:bg-gray-800/50 rounded-xl mt-4 border border-gray-100 dark:border-gray-700"><div class="inline-block p-3 bg-indigo-50 rounded-xl">${getIcon('Search')}</div><p class="mt-3 text-sm text-gray-500">Start typing to search...</p></div>`;
    }
  }

  function renderTreePanelOnly(){
    const container = document.getElementById('tree-panel-area');
    if(!container) return;
    const l1 = getUniqueOptions('L1');
    const l2 = getUniqueOptions('L2', selectedL1);
    const l3 = getUniqueOptions('L3', selectedL1, selectedL2);

    container.innerHTML = `
      <div class="flex justify-between items-center mb-4">
        <h2 class="font-bold text-gray-700 dark:text-gray-200 text-lg">Request Type Tree</h2>
        <button id="reset-tree-btn" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-600 dark:text-gray-300 text-xs font-semibold py-1.5 px-3 rounded">Reset</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        ${renderDropdown('l1-select','Level 1', l1, selectedL1, true)}
        ${renderDropdown('l2-select','Level 2', l2, selectedL2, !!selectedL1)}
        ${renderDropdown('l3-select','Level 3', l3, selectedL3, selectedL2 && l3.length > 0)}
      </div>
      ${currentFinalRequest ? `<div class="border-t dark:border-gray-700 pt-6 animate-fade-in"><h3 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">Selected Request Type</h3>
        ${renderCard(currentFinalRequest, null, false)}</div>` : ''}
    `;

    document.getElementById('l1-select')?.addEventListener('change', handleL1Change);
    document.getElementById('l2-select')?.addEventListener('change', handleL2Change);
    document.getElementById('l3-select')?.addEventListener('change', handleL3Change);
    document.getElementById('reset-tree-btn')?.addEventListener('click', handleResetTree);
  }

  function renderDropdown(id,label,options,selected,enabled){
    const opts = options.map(o => `<option value="${escapeHtml(o)}" ${o===selected ? 'selected' : ''}>${escapeHtml(o)}</option>`).join('');
    return `
      <div>
        <label class="text-sm font-semibold text-gray-700 dark:text-gray-300">${escapeHtml(label)}</label>
        <select id="${id}" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" ${!enabled ? 'disabled' : ''}>
          <option value="" ${!selected ? 'selected' : ''}>${!enabled && options.length === 0 ? 'N/A' : 'Select...'}</option>
          ${opts}
        </select>
      </div>
    `;
  }

  function renderApp(){
    if(isLoading){
      appDiv.innerHTML = `<div class="flex flex-col items-center justify-center h-64 gap-4">${getIcon('Loader')}<span>Loading Request Data...</span></div>`;
      return;
    }
    if(errorMsg){
      appDiv.innerHTML = `<div class="p-6 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-200 rounded-xl text-center">${escapeHtml(errorMsg)}<div class="mt-4"><button id="refresh-btn-err" class="px-4 py-2 bg-indigo-600 text-white rounded">Retry</button></div></div>`;
      document.getElementById('refresh-btn-err')?.addEventListener('click', ()=> fetchData(false));
      return;
    }
    if(!isLayoutLoaded) renderShell();
    renderSearchResultsOnly();
    renderTreePanelOnly();
  }

  // -----------------------
  // Tree handlers
  // -----------------------
  function handleL1Change(e){ selectedL1 = e.target.value; selectedL2 = ''; selectedL3 = ''; currentFinalRequest = null; renderTreePanelOnly(); }
  function handleL2Change(e){ selectedL2 = e.target.value; selectedL3 = ''; const l3opts = getUniqueOptions('L3', selectedL1, selectedL2); if(l3opts.length===0){ currentFinalRequest = requestTypesData.find(i=>i.L1===selectedL1 && i.L2===selectedL2 && (!i.L3 || i.L3.trim()==='')); } else currentFinalRequest = null; renderTreePanelOnly(); }
  function handleL3Change(e){ selectedL3 = e.target.value; currentFinalRequest = requestTypesData.find(i=>i.L1===selectedL1 && i.L2===selectedL2 && i.L3===selectedL3); renderTreePanelOnly(); }
  function handleResetTree(){ selectedL1 = selectedL2 = selectedL3 = ''; currentFinalRequest = null; renderTreePanelOnly(); }
  function handleSearchInput(e){ searchTerm = e.target.value; debouncedUpdateSearch(searchTerm); }
  window.handleSearchInput = handleSearchInput;
  const debouncedUpdateSearch = debounce((t)=> renderSearchResultsOnly(t), 300);

  function updateFooter(){
    const f = document.querySelector('footer');
    if(f) f.innerHTML = `Connected to Live Sheet • ${requestTypesData.length} Request Types Loaded • Last Sync: ${new Date().toLocaleTimeString()}`;
  }

  // -----------------------
  // Start
  // -----------------------
  fetchData();
  setInterval(()=> fetchData(true), AUTO_REFRESH_INTERVAL);
  </script>
</body>
</html>
